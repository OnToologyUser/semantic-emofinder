<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Semantic Emofinder</title>
        
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    </head>
    <body>
        <header class="py-2 mb-2 border-bottom bg-body-tertiary">
            <div class="d-flex flex-wrap container">
              <a class="mb-3 mb-md-0 me-md-auto link-body-emphasis text-decoration-none">
                <span class="fs-2">Semantic Emofinder</span>
              </a>
        
              <ul class="nav nav-pills">
                <li class="nav-item"><a href="/" class="nav-link active" aria-current="page">Buscador</a></li>
                <li class="nav-item"><a href="bases.html" class="nav-link">Bases</a></li>
                <li class="nav-item"><a href="examples.html" class="nav-link">Ejemplos</a></li>
              </ul>
            
            </div>
        </header>
        
        <div class="container">
            <div class="row text-center">
                <h2>Buscar palabras</h2>
            </div>
            <form>
                <div class="row">
                    <div class="col-md-8">
                        <legend>Filtros de búsqueda <button type="button" class="btn btn-secondary" data-bs-container="body" data-bs-toggle="popover" data-bs-placement="bottom" 
                            data-bs-content="Escribir en el campo correspondiente el inicio, final o parte contenida de las palabras para filtrar. El campo de palabra exacta solo admite una palabra y tiene prioridad sobre el resto de campos. Escribir sin espacios ni símbolos">
                            ?
                          </button></legend>
                        
                        <div class="border-bottom border-top py-2 my-2">
                            <div class="row mb-2">
                                <label for="inicio_palabra" class="col-sm-2 col-form-label">Empiza por:</label>
                                <div class="col-4">
                                    <input type="text" class="form-control filtro-palabra" name="inicio_palabra" id="inicio_palabra">
                                </div>
                                <label for="fin_palabra" class="col-sm-2 col-form-label">Acaba en:</label>
                                <div class="col-4">
                                    <input type="text" class="form-control filtro-palabra" name="fin_palabra" id="fin_palabra">
                                </div>
                            </div>
                            <div class="row mb-2">
                                <label for="contiene_palabra" class="col-sm-2 col-form-label">Contiene:</label>
                                <div class="col-4">
                                    <input type="text" class="form-control filtro-palabra" name="contiene_palabra" id="contiene_palabra">
                                </div>
                                <label for="palabra_exacta" class="col-sm-2 col-form-label">Palabra exacta:</label>
                                <div class="col-4">
                                    <input type="text" class="form-control filtro-palabra" name="palabra_exacta" id="palabra_exacta">
                                </div>
                            </div>
                            
                        </div>
                        <legend>Selección de características <button type="button" class="btn btn-secondary" data-bs-container="body" data-bs-toggle="popover" data-bs-placement="bottom" 
                            data-bs-content="Selecciona la característica en el desplegable de la derecha de cada bloque. El desplegable de la izquierda permite filtrar por tipos las características. Usar varias caracteristicas puede requerir mucho tiempo. Si los límites se dejan en blanco no se tendrán en cuenta. El separador decimal aceptado es el punto (.)">
                            ?
                          </button></legend>

                        <div class="border-bottom pb-2 mb-2 bloque">
                            <div class="mb-3">
                            <label class="form-label">Característica:</label>
                            
                            <div class="row">
                                <div class="col-6">
                                    <select class="form-select tipo">
                                        <option value="0" selected>Todas</option>
                                        <option value="1">Dimensión emocional</option>
                                        <option value="2">Categoría emocional</option>
                                        <option value="3">Tiempos de reconocimiento</option>
                                        <option value="4">Otras características</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <select class="form-select caracteristica">
                                        <option class="1 2 3 4" selected>Seleccionar</option>
                                        <option class="1">Valencia</option>
                                        <option class="1">Activación</option>
                                        <option class="1">Dominancia</option>
                                        <option class="2">Miedo</option>
                                        <option class="2">Ira</option>
                                        <option class="2">Alegría</option>
                                        <option class="2">Tristeza</option>
                                        <option class="2">Asco</option>
                                        <option class="3">Tiempo Naming</option>
                                        <option class="3">Tiempo Tdl</option>
                                        <option class="4">Familiaridad</option>
                                        <option class="4">Disponibilidad contextual</option>
                                        <option class="4">Imaginabilidad</option>
                                        <option class="4">Concreción</option>
                                        <option class="4">Experiencia sensorial</option>
                                        <option class="4">Edad de adquisición</option>
                                    </select>
                                </div>
                            </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col">
                                    <p class="mb-0">Media:</p>
                                </div>
                                <div class="col">
                                    <input type="text" class="form-control dato" placeholder="Límite inferior" name="valor_inf_m">
                                </div>
                                <div class="col">
                                    <input type="text" class="form-control dato" placeholder="Límite Superior" name="valor_sup_m">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col">
                                    <p class="mb-0">Desviación típica:</p>
                                </div>
                                <div class="col">
                                    <input type="text" class="form-control dato desv" placeholder="Límite inferior" name="valor_inf_sd">
                                </div>
                                <div class="col">
                                    <input type="text" class="form-control dato desv" placeholder="Límite Superior" name="valor_sup_sd">
                                </div>
                            </div>
                            <button type="button" class="btn btn-danger eliminar" disabled>Eliminar característica</button>
                            </div>

                            <div class="d-grid gap-3">
                                <button type="button" class="btn btn-secondary btn-block" id="anhadir">Añadir nueva característica</button>
                                <button type="button" class="btn btn-primary btn-block" id="buscar" disabled>Buscar</button>
                            </div>
                    </div>

                    <div class="col-md-4 border ">
                        <div id="select-bases">
                        <legend>Bases de palabras <button type="button" class="btn btn-secondary" data-bs-container="body" data-bs-toggle="popover" data-bs-placement="bottom" 
                            data-bs-content="Selecciona las bases de palabras para limitar la busqueda. No seleccionar ninguna es equivalente a seleccionar todas las bases">
                            ?
                          </button></legend>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="alonso_2015" id="base1">
                            <label class="form-check-label" for="base1">
                                alonso_2015
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="ferre_2012" id="base2">
                            <label class="form-check-label" for="base2">
                                ferre_2012
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="ferre_2017" id="base3">
                            <label class="form-check-label" for="base3">
                                ferre_2017
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="gonzalez_nosti_2014" id="base4">
                            <label class="form-check-label" for="base4">
                                gonzalez_nosti_2014
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="guasch_2016" id="base5">
                            <label class="form-check-label" for="base5">
                                guasch_2016
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="hinojosa_2016a" id="base6">
                            <label class="form-check-label" for="base6">
                                hinojosa_2016a
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="hinojosa_2016b" id="base7">
                            <label class="form-check-label" for="base7">
                                hinojosa_2016b
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="redondo_2005" id="base8">
                            <label class="form-check-label" for="base8">
                                redondo_2005
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="redondo_2007" id="base9">
                            <label class="form-check-label" for="base9">
                                redondo_2007
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="stadthagen_gonzalez_2017" id="base10">
                            <label class="form-check-label" for="base10">
                                stadthagen_gonzalez_2017
                            </label>
                        </div>
                        </div>

                        <legend>Método de búsqueda</legend>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="FiltrosBases" id="alguno" value="1" checked="" disabled>
                            <label class="form-check-label" for="alguno">Coincide en alguna base</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="FiltrosBases" id="todo" value="2" disabled>
                            <label class="form-check-label" for="todo">Coincide en todas las bases</label>
                        </div>
                    </div>
                </div>
            </form>
            <div id="resultado">

            </div>
        </div>
    </body>
    <script>
        var dict = {
            "Valencia":"Valence",
            "Activación":"Arousal",
            "Dominancia":"Dominance",
            "Miedo":"Fear",
            "Ira":"Anger",
            "Alegría":"Happiness",
            "Tristeza":"Sadness",
            "Asco":"Disgust",
            "Tiempo Naming":"TimeNaming",
            "Tiempo Tdl":"TimeTdl",
            "Familiaridad":"Familiarity",
            "Disponibilidad contextual":"ContextualAvailability",
            "Imaginabilidad":"Imageability",
            "Concreción":"Concreteness",
            "Experiencia sensorial":"SensoryExperience",
            "Edad de adquisición":"AcquisitionAge"            
        }

        // extraido de https://www.geeksforgeeks.org/how-to-export-html-table-to-csv-using-javascript/
        function tableToCSV() {

            // Variable to store the final csv data
            let csv_data = [];

            // Get each row data
            let rows = document.getElementsByTagName('tr');
            for (let i = 0; i < rows.length; i++) {

                // Get each column data
                let cols = rows[i].querySelectorAll('td,th');

                // Stores each csv row data
                let csvrow = [];
                for (let j = 0; j < cols.length; j++) {

                    // Get the text data of each cell
                    // of a row and push it to csvrow
                    csvrow.push(cols[j].innerHTML);
                }

                // Combine each column value with comma
                csv_data.push(csvrow.join(","));
            }

            // Combine each row data with new line character
            csv_data = csv_data.join('\n');

            // Call this function to download csv file  
            downloadCSVFile(csv_data);

        }

        function downloadCSVFile(csv_data) {

            // Create CSV file object and feed
            // our csv_data into it
            CSVFile = new Blob([csv_data], {
                type: "text/csv"
            });

            // Create to temporary link to initiate
            // download process
            let temp_link = document.createElement('a');

            // Download csv file
            temp_link.download = "resultados.csv";
            let url = window.URL.createObjectURL(CSVFile);
            temp_link.href = url;

            // This link should not be displayed
            temp_link.style.display = "none";
            document.body.appendChild(temp_link);

            // Automatically click the link to
            // trigger download
            temp_link.click();
            document.body.removeChild(temp_link);
        }

        function filterSelect(){
            var opciones = $(this).parent().parent().find(".caracteristica").first()
            opciones.html('<option class="1 2 3 4" selected>Seleccionar</option>'+
                                            '<option class="1">Valencia</option>'+
                                            '<option class="1">Activación</option>'+
                                            '<option class="1">Dominancia</option>'+
                                            '<option class="2">Miedo</option>'+
                                            '<option class="2">Ira</option>'+
                                            '<option class="2">Alegría</option>'+
                                            '<option class="2">Tristeza</option>'+
                                            '<option class="2">Asco</option>'+
                                            '<option class="3">Tiempo Naming</option>'+
                                            '<option class="3">Tiempo Tdl</option>'+
                                            '<option class="4">Familiaridad</option>'+
                                            '<option class="4">Disponibilidad contextual</option>'+
                                            '<option class="4">Imaginabilidad</option>'+
                                            '<option class="4">Concreción</option>'+
                                            '<option class="4">Experiencia sensorial</option>'+
                                            '<option class="4">Edad de adquisición</option>')
            
            if ($(this).val()!=="0"){
                var k = $(this).val()
                opciones.find("option:not(."+k+")").remove()
            }
        }

        function checkSearch(){
            $("#buscar").prop("disabled",true);
            $(".caracteristica").find(":selected").each(function(){
                if($(this).text() !== "Seleccionar"){
                    $("#buscar").prop("disabled",false);
                }
                if($(this).text() === "Tiempo Naming" || $(this).text() === "Tiempo Tdl"){
                    $(this).parentsUntil(".bloque").last().parent().find(".desv").prop("disabled",true)
                }else{
                    $(this).parentsUntil(".bloque").last().parent().find(".desv").prop("disabled",false)
                }
            })
        }

        function removeCaracteristic(){
            $(this).parent().remove();
            $("#anhadir").prop("disabled",false);
            if($(".bloque").length <= 1){
                $(".eliminar").prop("disabled",true);
            }
            checkSearch()
        }

        function addCaracteristic(){
            var caract = '<div class="border-bottom pb-2 mb-2 bloque">'+
                            '<div class="mb-3">'+
                                '<label class="form-label">Característica:</label>'+
                                '<div class="row">'+
                                    '<div class="col-6">'+
                                        '<select class="form-select tipo">'+
                                            '<option value="0" selected>Todas</option>'+
                                            '<option value="1">Dimensión emocional</option>'+
                                            '<option value="2">Categoría emocional</option>'+
                                            '<option value="3">Tiempos de reconocimiento</option>'+
                                            '<option value="4">Otras características</option>'+
                                        '</select>'+
                                    '</div>'+
                                    '<div class="col-6">'+
                                        '<select class="form-select caracteristica">'+
                                            '<option class="1 2 3 4" selected>Seleccionar</option>'+
                                            '<option class="1">Valencia</option>'+
                                            '<option class="1">Activación</option>'+
                                            '<option class="1">Dominancia</option>'+
                                            '<option class="2">Miedo</option>'+
                                            '<option class="2">Ira</option>'+
                                            '<option class="2">Alegría</option>'+
                                            '<option class="2">Tristeza</option>'+
                                            '<option class="2">Asco</option>'+
                                            '<option class="3">Tiempo Naming</option>'+
                                            '<option class="3">Tiempo Tdl</option>'+
                                            '<option class="4">Familiaridad</option>'+
                                            '<option class="4">Disponibilidad contextual</option>'+
                                            '<option class="4">Imaginabilidad</option>'+
                                            '<option class="4">Concreción</option>'+
                                            '<option class="4">Experiencia sensorial</option>'+
                                            '<option class="4">Edad de adquisición</option>'+
                                        '</select>'+
                                    '</div>'+
                                '</div>'+
                            '</div>'+
                            '<div class="row mb-2">'+
                                '<div class="col">'+
                                    '<p class="mb-0">Media:</p>'+
                                '</div>'+
                                '<div class="col">'+
                                    '<input type="text" class="form-control dato" placeholder="Límite inferior" name="valor_inf_m">'+
                                '</div>'+
                                '<div class="col">'+
                                    '<input type="text" class="form-control dato" placeholder="Límite Superior" name="valor_sup_m">'+
                                '</div>'+
                            '</div>'+
                            '<div class="row">'+
                                '<div class="col">'+
                                    '<p class="mb-0">Desviación típica:</p>'+
                                '</div>'+
                                '<div class="col">'+
                                    '<input type="text" class="form-control dato desv" placeholder="Límite inferior" name="valor_inf_sd">'+
                                '</div>'+
                                '<div class="col">'+
                                    '<input type="text" class="form-control dato desv" placeholder="Límite Superior" name="valor_sup_sd">'+
                                '</div>'+
                            '</div>'+
                            '<button type="button" class="btn btn-danger eliminar">Eliminar característica</button>'+
                        '</div>';
            $(".bloque").last().after(caract);
            $(".eliminar").click(removeCaracteristic);
            $(".tipo").change(filterSelect);
            $(".caracteristica").change(checkSearch);

            $(".eliminar").prop("disabled",false);
            if($(".bloque").length >= 3){
                $("#anhadir").prop("disabled",true);
            }
        }

        function filterSearch(){
            //comprobaciones previas
            var correcto = true;
            $(".filtro-palabra").each(function(){
                if(!/^[a-zA-ZÀ-ÿ]*$/.test($(this).val())){
                    correcto=false
                    $(this).addClass("border-danger")
                }else{
                    $(this).removeClass("border-danger")
                }
            })

            $(".dato").each(function(){
                if(!/^(-[0-9]+(\.[0-9]+)?)?$/.test($(this).val())){
                    correcto=false
                    $(this).addClass("border-danger")
                }else{
                    $(this).removeClass("border-danger")
                }
            })
            if(correcto){

            
                var parametros = "";
                //patrones palabras
                if($("#palabra_exacta").val()){
                    parametros += "^"+$("#palabra_exacta").val()+ "$-";
                }else{
                    if($("#inicio_palabra").val()){
                        parametros += "^"+ $("#inicio_palabra").val() + "-";
                    }
                    if($("#contiene_palabra").val()){
                        parametros += $("#contiene_palabra").val() + "-";
                    }
                    if($("#fin_palabra").val()){
                        parametros +=  $("#fin_palabra").val() + "$-";
                    }
                }
                parametros += "|";

                //caracteristicas y umbrales
                $(".bloque").each(function(index){
                    if($(this).find(".caracteristica").first().find(":selected").text() !== "Seleccionar"){
                        parametros += dict[$(this).find(".caracteristica").first().find(":selected").text()] + ":";
                        $(this).find(".dato").each(function(i){
                            parametros += $(this).val() + "-";
                        })
                        parametros += ";";
                    }
                })
                parametros += "|";

                //bases
                $("#select-bases :checked").each(function(){
                    parametros += $(this).val() + ";";
                })

                //consulta
                $("#buscar").prop("disabled",true);
                $("#buscar").text("Realizando la búsqueda...");
                $.getJSON("/consulta_caracteristica",{
                    param: parametros
                },function(data){
                    $("#buscar").prop("disabled",false);
                    $("#buscar").text("Buscar");
                    if ($("#tresultado").length <= 0 ){
                        $("#resultado").prepend('<div class="row text-center">'+
                            '<h2>Resultado de la consulta</h2>'+
                            '</div>'+
                            '<button type="button" class="btn btn-primary" onclick="tableToCSV()">Descargar</button>'+
                            '<div id="tresultado"></div>'
                        )
                    }

                    var table = $('<table class="table table-hover">');
                    var tblHeader = "<thead> <tr>";
                    for (var h in data.head.vars){
                        tblHeader += "<th>" + data.head.vars[h] + "</th>";
                    } 
                    tblHeader += "</tr> </thead>";
                    $(tblHeader).appendTo(table);

                    tblHeader += "</tr> </thead>";
                    $(table).append("<tbody>");
                    $.each(data.results.bindings, function (index, value) {
                        var TableRow = "<tr>";
                        for (var h in data.head.vars){
                            TableRow += "<td>" + value[data.head.vars[h]].value + "</td>";
                        }
                        TableRow += "</tr>";
                        $(table).append(TableRow);
                    });
                    $(table).append("</tbody>");
                    

                    $("#tresultado").html(table);   //DOM table doesn't have .appendChild
                })
            }
            
        }

        $(document).ready(function(){
            $('[data-bs-toggle="popover"]').popover();
            $(".eliminar").click(removeCaracteristic);
            $("#anhadir").click(addCaracteristic);
            $("#buscar").click(filterSearch);
            $(".tipo").change(filterSelect);
            $(".caracteristica").change(checkSearch);
        });
        
    </script>
</html>